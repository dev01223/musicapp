{%load static%}
<html>

<head>
    <meta charset="utf-8">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <link rel="stylesheet" href="{%static 'css/home.css'%}">

</head>

<body>

    <header  class="fluid-container p-3 d-flex w-100 justify-content-center text-center justify-content-between" style="background:#000 !important;">
        <div class="d-flex mobile-flex align-items-center" style="gap:.5rem">
            <img style="height:2rem;" src="{%static 'img/Untitled_design__14_-removebg-preview (1).png' %}">             <img style="height:2rem;" src="{%static 'img/Untitled_design__15_-removebg-preview (1) (1).png' %}">

        </div>
        <div class="d-flex align-items-center">
    <span class="text-center" style="color:#fff; font-size:1.5rem !important;"><img style="height:1.5rem;" src="{% static 'img/open-exit-door.png' %}"> </span>
    <span style="color:#fff; ">R$ <span class="saldo">{{ user.saldo|floatformat:2 }}<span></span>
        </div>
      </header>
      <img class="detalhe2" src="{%static 'img/Untitled design (10) (1).png' %}">

  <!--  
    <span style="color:#fff;" class="mt-5">Olá {{user.username}}    </span>
   
-->

<div class="container d-flex justify-content-center flex-column align-items-center">
    <span class="d-none text-center mt-4 mb-3" style="color:#fff; font-size:1.2rem">Temporizador: <span class="timer">0</span></span> 


    <span class="text-center mt-5 mb-3" style="color:#fff; font-size:1.3rem">Ouça para aumentar seu saldo!</span> 
 
 
    <div class="d-none">
    <span>{{user.username}}</span>
    {% if user.is_authenticated %}
    <form class="d-flex align-items-center " action="{% url 'logout' %}" method="post">
        {% csrf_token %}
        <button type="submit" class="nav-item nav-link" style="border:none; background:none;">Sair</button>
    </form>
{% endif %}    

</div>

   <span class="text-center mt-4" style="color:#fff; font-size:1.6rem">Saldo disponível</span> 
   <div class="d-flex align-items-center justify-content-center mb-2" style="gap:.5rem">    <img style="height:2rem" src="{%static 'img\moedas (1).png' %}">
    <span class="text-center" style="color:#fff; font-size:1.6rem"> R$ <span class=" saldo" style="color:#fff; font-size:1.6rem">{{ user.saldo|floatformat:2 }}</span> </span>  </div>
    <div class="progress-bar" style="width:30rem; position: relative; height: .5rem; background: rgb(193, 190, 190);">
    <span class="inner-bar" style="  position:absolute; background: rgb(33, 149, 33); height: 100%; left:0; top:0;"></span></div>
</div> 

<div class="container d-flex justify-content-center align-items-center mt-5">

<button class="dobroBtn" style="display: none; background: rgb(255, 238, 238); padding:.7rem 2rem; font-size:2rem; border-radius:30px; outline: none; border: none; box-shadow: rgb(117, 255, 117) 5px 5px;">RECEBA EM DOBRO</button>

</div>

<div class="container mt-3 mb-5">
    <div class="d-flex container flex-column justify-content-center align-items-center" style="max-width:30rem;   border-radius:15px;">
<img style="height: 17rem;" src="{%static 'img\Untitled design.png' %}">
<span class="music mt-2 text-center" style="font-size: 2rem; font-weight: 500; color:#fff !important; padding:.7rem 4.5rem; border-radius:70px; border:solid 4px #fff; box-shadow: #fff 0px 0px 20px;"> Music Pay</span>

<span class="mt-5 text-center" style="color:#fff; font-size:1.4rem;">  O APP QUE TE PAGA PRA DAR UM PLAY</span>

<div class=" mt-4 d-flex text-center player align-items-center player" style="border-radius:4px; padding:1.2rem 2rem; gap:3.5rem;">
  
    <img style="height:3rem" class="repetir" src="{%static 'img\repetir.png' %}">

    <img id="prev" style="height:3rem; transform: rotate(180deg);"  src="{% static 'img\proximo.png' %}">

    <img id="play" style="height:3rem" src="{%static 'img\botao-play-ponta-de-seta.png' %}">


    <img id="next" style="height:3rem" src="{%static 'img\proximo.png' %}">
    <img style="height:3rem" class="compartilhar" src="{%static 'img\compartilhar.png' %}">



</div>
<div class="d-flex justify-content-start align-items-center flex-column w-100">


</div>

    </div>

</div>
<script>
    localStorage.setItem('isUserLoggedIn', true);
</script>
<div class="main-container align-items-center justify-content-center" style="background:rgba(0, 0, 0, 0.35);top:0; height: 100vh; width:100vw; position: fixed; display: none; ">

    <div class="container d-flex justify-content-center">
    <div class="d-flex flex-column p-4  align-items-center" style="width:30rem; max-width:100%; background: #fff; border-radius:12px;">

        <span class="mt-1">Saldo Atualizado!</span>
        <span class="mt-3" style="font-size:1rem">Você recebeu:</span>
        <span class="mt-1" style="font-size:2rem; font-weight: 900;">R$ 69.00</span>
        <span class="mt-1" style="font-size:1rem">Pelo código da Nike</span>



    </div>
</div>

</div>
<div id="minhaDiv" style="color:#fff"></div>

<div class="fluid-container mb-4 d-flex justify-content-center align-items-center flex-column text-center w-100" style="border-top:solid 2px rgb(54, 218, 54);">


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<a href="{%url 'saque'%}" class="mb-5 mt-5" href="playlist1.html"><img style="height:4rem;" src="{%static 'img/Untitled design (3) (1).png' %}"></a>

</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>



<script>
    var timer = null;
    let valor = document.querySelectorAll('.valor')
    let temporizador = document.querySelector('.timer')
    let saldoSpans = document.querySelectorAll(".saldo");
    let inner = document.querySelector('.inner-bar')
    var elapsedTimeString = '{{ user.elapsed_time|default_if_none:"0" }}';
    var saldoUserString = '{{ user.saldo|default_if_none:"0" }}';
    
    // Limpe a string removendo tudo o que não é dígito ou ponto.
    elapsedTimeString = elapsedTimeString.replace(/[^\d.]/g, '');
    saldoUserString = saldoUserString.replace(/[^\d.]/g, '');
    
    // Agora converta as strings limpas para floats.
    var elapsedTime = parseFloat(elapsedTimeString);
    var saldoUser = parseFloat(saldoUserString);

    // Use toFixed(2) para formatar o saldo como uma string com duas casas decimais quando necessário para exibição.
    var saldoUserFormatted = saldoUser.toFixed(2);
    var larguraBarra = parseFloat('{{ user.largura_barra|default_if_none:"0" }}');
    inner.style.width = larguraBarra + '%';      

            function salvarSaldoNoLocalStorage(saldo) {
                localStorage.setItem('saldo', saldo);
            }
            
            function recuperarSaldoDoLocalStorage() {
                // Retorna o saldo do localStorage, ou 0 se não houver saldo salvo
                return localStorage.getItem('saldo') || '0';
            }
            
            function atualizarSaldoNaTela(saldo) {
                // Antes de atualizar, verifique se o "R$" já está presente.
                saldoSpans.forEach((span) => {
                    span.textContent = `R$ ${saldo}`; // Certifique-se de que "R$" não é adicionado no HTML.
                });
                salvarSaldoNoLocalStorage(saldo); // Salva o saldo no localStorage
            }

            function salvarLarguraBarraNoLocalStorage(percent) {
                localStorage.setItem('larguraBarra', percent.toString());
            }
            
            function recuperarLarguraBarraDoLocalStorage() {
                // Retorna a largura da barra do localStorage, ou '0%' se não houver largura salva
                return localStorage.getItem('larguraBarra') || '0%';
            }
            
            function atualizarLarguraBarraNaTela(percent) {
                inner.style.width = percent;
                salvarLarguraBarraNoLocalStorage(percent); // Salva a largura da barra no localStorage
            }
    
            function updateTime() {
                elapsedTime += 1000; // Adiciona 1 segundo ao tempo total
                tempo = elapsedTime / 1000;
                temporizador.textContent = tempo.toString();
                var percent = Math.min((tempo / 500) * 100, 100); // Assegura que não ultrapasse 100%
            
                if(saldoUser < 50) {
                    saldoUser += 0.1;
                }
            
                // Formata o saldo para sempre ter 1 dígito antes e 2 dígitos depois da vírgula
                let saldoFormatado = formatarSaldo(saldoUser);
            
                // Atualiza o conteúdo de todos os elementos com a classe 'saldo'
                saldoSpans.forEach((span) => {
                    span.textContent = saldoFormatado;
                });
            
                inner.style.width = percent + '%'; // Ajusta a largura baseada na porcentagem
                atualizarLarguraBarraNaTela(percent + '%');

                if (typeof elapsedTime !== 'undefined' && typeof saldoUser !== 'undefined' && inner) {
                    enviarDadosParaServidor();
                }

                // Na inicialização da página ou aplicação
            }
     
        
            
            function formatarSaldo(saldo) {
                saldo = Number(saldo);
                let saldoFormatado = saldo.toFixed(2);
            
                // Se o saldo for menor que 1 e maior ou igual a 0, ou menor que 0 e maior ou igual a -1,
                // garantir que apenas um '0' apareça antes do ponto decimal.
                if ((saldo >= 0 && saldo < 1) || (saldo < 0 && saldo >= -1)) {
                    saldoFormatado = saldo >= 0 ? '0' + saldoFormatado : '-0' + saldoFormatado.substring(1);
                }
            
                // Remove zeros extras no início
                saldoFormatado = saldoFormatado.replace(/^0+/, '0');
            
                return saldoFormatado;
            }
            


const musicList = ["/static/img/505.mp3", "/static/img/Me Gustas tu - Manu Chao (cover).mp3", "/static/img/Yamê - Bécane _ A COLORS SHOW.mp3", "/static/img/Casuarina - Disritmia (DVD MTV Apresenta_ Casuarina).mp3", "/static/img/Cartola - Preciso Me Encontrar (Audio Oficial).mp3", "/static/img/Trem Das Onze.mp3" ];
let currentTrackIndex = 0;
const audioPlayer = new Audio(musicList[currentTrackIndex]);
let playButton = document.querySelector('#play')
let prev = document.querySelector('#prev')
let next = document.querySelector('#next')


playButton.addEventListener('click', () => {
    pauseTimer();

    if (playButton.src.includes("botao-de-pausa.png")) {
        playButton.src = "/static/img/botao-play-ponta-de-seta.png"; // caminho para a imagem de play

    } else {
        playButton.src = "/static/img/botao-de-pausa.png";

        startTimer();
         // caminho para a imagem de pause
    }

    if (audioPlayer.paused) {
        audioPlayer.play();
        

    } else {
        audioPlayer.pause();
    }
});

next.addEventListener('click', function()
{
    playButton.src = "/static/img/botao-de-pausa.png";
    startTimer();


})

prev.addEventListener('click', function()
{
    playButton.src = "/static/img/botao-de-pausa.png";
    startTimer();


})



document.getElementById('next').addEventListener('click', () => {
    currentTrackIndex = (currentTrackIndex + 1) % musicList.length;
    audioPlayer.src = musicList[currentTrackIndex];
    audioPlayer.play();
});

document.getElementById('prev').addEventListener('click', () => {
    currentTrackIndex = (currentTrackIndex - 1 + musicList.length) % musicList.length;
    audioPlayer.src = musicList[currentTrackIndex];
    audioPlayer.play();
});
        </script>

<script type="text/javascript">
    window.onload = function() {
        let dobroBtn = document.querySelector('.dobroBtn');
        var nomeDoCookie = "primeiraVisita";
        var div = document.getElementById("minhaDiv");
        var cookie = getCookie(nomeDoCookie);

        if (cookie === "") {
            // Primeira visita
            var agora = new Date();
            agora.setTime(agora.getTime() + (1 * 24 * 60 * 60 * 1000)); // 1 dia
            document.cookie = nomeDoCookie + "=" + agora.toUTCString() + ";path=/";
        } else {

            var dataPrimeiraVisita = new Date(cookie);
            var agora = new Date();
            if (agora - dataPrimeiraVisita >= 72 * 60 * 60 * 1000) {
                
                window.location.href = 'saque.html';

            }

            else if (agora - dataPrimeiraVisita >= 48 * 60 * 60 * 1000) {
                dobroBtn.textContent = 'SAQUE EXPRESSO'
                dobroBtn.style.display = 'block'

            }

            else if (agora - dataPrimeiraVisita >= 24 * 60 * 60 * 1000) {
    
                dobroBtn.style.display = 'block'
            // Aqui você pode também alterar outros estilos da div, se necessário
            }
        }
    };

    function getCookie(nome) {
        var nomeIGUAL = nome + "=";
        var ca = document.cookie.split(';');
        for(var i=0; i < ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) === ' ') {
                c = c.substring(1);
            }
            if (c.indexOf(nomeIGUAL) === 0) {
                return c.substring(nomeIGUAL.length, c.length);
            }
        }
        return "";
    }
    function enviarDadosParaServidor() {
        
        const csrftoken = getCookie('csrftoken'); // Substitua 'csrftoken' pelo nome do cookie que contém o token CSRF

    
        const data = {
            larguraBarra: inner.style.width,
            elapsedTime: elapsedTime,
            saldoUser: saldoUser,
        };
        fetch('https://musicaapp.onrender.com/update_data/', {

                    method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            // Verificar se a resposta é JSON
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.includes("application/json")) {
                return response.json();
            }
            throw new TypeError("Oops, não recebemos JSON!");
        })
        .then(data => console.log(data))
        .catch((error) => console.error('Erro:', error));
    }

    function startTimer() {
        if (timer === null) {
            timer = setInterval(updateTime, 1000); // Atualiza a cada segundo
        }
    }

    function pauseTimer() {
        if (timer !== null) {
            clearInterval(timer);
            timer = null;
        }
    }


</script>

</body>




</html>